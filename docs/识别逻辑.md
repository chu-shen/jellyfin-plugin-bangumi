# 元数据识别

- [元数据识别](#元数据识别)
  - [节目识别](#节目识别)
  - [集数识别](#集数识别)
    - [使用默认规则获取集数](#使用默认规则获取集数)
    - [使用 AnitomySharp 获取集数](#使用-anitomysharp-获取集数)
  - [剧集识别](#剧集识别)
    - [使用默认规则获取剧集](#使用默认规则获取剧集)
    - [使用 AnitomySharp 获取剧集](#使用-anitomysharp-获取剧集)
  - [季度识别](#季度识别)


## 节目识别

**涉及内容：**

- 条目识别
- 条目修正
  - 手动修正
  - 自动修正

**识别流程：**

1. 从配置获取 Bangumi ID
   1. 从本地配置获取 ID
   2. 若无，且已勾选`始终根据配置的 Bangumi ID 获取元数据`配置
      1. 从路径获得 ID，形如`ホワイトアルバム2[bangumi-69496]`
      2. 若无，则从 Jellyfin 元数据获取 ID
   3. 否则，`ID=0`，执行后续搜索匹配


2. 从搜索结果获取 Bangumi ID
   1. 执行解析规则（见后文）
   2. 若无，则使用 Jellyfin 标题进行搜索
   3. 若无，且 Jellyfin 标题与原标题不同，则使用原标题进行搜索
   4. 否则，结束识别


**解析规则：**
1. 如果已勾选`使用 AnitomySharp 猜测动画名`配置，则使用 AnitomySharp 猜测动画名并进行搜索


**已知问题：**
- 匹配错误的条目如何修正
  - 是否从 Jellyfin 元数据获取 ID？目前修改为需要勾选`始终根据配置的 Bangumi ID 获取元数据`配置
  - 错误条目如果带年份`info.Year`，则多半会导致重新识别时继续出错


## 集数识别

**涉及内容：**

- 集数识别
- 集数修正
  - 手动修正
  - 自动修正

**识别流程：**

1. 如果已勾选`使用 AnitomySharp 猜测集数`，则[使用 AnitomySharp 获取剧集](#使用-anitomysharp-获取集数)
2. 否则，如已勾选`始终根据文件名猜测集数`或 Jellyfin 元数据中集数为空或0，则[使用默认规则获取集数](#使用默认规则获取集数)
3. 如果本地配置了偏移值，则在前面的基础上减去该偏移值（支持正负数）


### 使用默认规则获取集数

#TODO


### 使用 AnitomySharp 获取集数

1. 使用 AnitomySharp 解析文件名获取获取集数
2. 若无，则判断文件大小。如果大于 100MB，则设置为`1`
      
        通常电影文件命名中并未包含集数，而 Bangumi 中则默认为第一集。设置为`1`有助于匹配 Bangumi 元数据

3. 否则，设置为`0`
4. 如果是特典，则不应用本地配置的偏移值（加上该偏移值）



## 剧集识别

**涉及内容：**

- 普通剧集识别
- 特典剧集识别
- 错误剧集修正
  - 手动指定
  - 自动修正

**识别流程：**

1. 如果已勾选`始终根据配置的 Bangumi ID 获取元数据`，则使用 Jellyfin 元数据中配置的剧集 ID
2. 如果此 ID 为`0`，或者未搜索到对应元数据，则执行解析规则（见后文）


**解析规则：**

1. 如果已勾选`使用 AnitomySharp 处理剧集`，则将[使用 AnitomySharp 获取剧集](#使用-anitomysharp-获取剧集)，并处理特典剧集
2. 否则，[使用默认规则获取剧集](#使用默认规则获取剧集)


### 使用默认规则获取剧集

#TODO


### 使用 AnitomySharp 获取剧集

**判断剧集类型：**

1. 使用 AnitomySharp 判断剧集类型
2. 如果为`null`，则再次判断剧集所在文件夹/虚拟文件夹（Jellyfin 季度）来决定剧集类型

**获取剧集元数据：**

1. 根据剧集类型获取 Bangumi 剧集元数据

2. 如果剧集元数据条数为 0，且剧集类型为`Special`
   1. **原因**：Bangumi 中本应为`Special`类型的剧集被划分到`Normal`类型的问题
   2. **措施**：获取此系列所有剧集元数据用于匹配

3. 如果剧集元数据条数为 0，且剧集类型为`SpecialOther`
   1. **原因**：用于标识剧集类型的仅有`SP`，若 Bangumi 有特典数据，则应匹配
   2. **措施**：尝试匹配 Bangumi 的特典元数据
   3. e.g. `[Girls und Panzer Saishuushou][Vol.03][SP02][Akiyama Yukari Panzer Lecture][BDRIP][1080P][H264_FLAC].mkv`


**匹配剧集元数据：**

1. 根据集数正常匹配剧集元数据

2. 如果未匹配上剧集元数据，且①剧集类型不为`null`、②集数为`0`、③剧集元数据条数不为`0`
   1. **原因**：该剧集类型下由于集数问题导致无法正确匹配
   2. **措施**：匹配第一个剧集元数据

3. 如果未匹配上剧集元数据，且剧集有备选集数（AnitomySharp 解析结果）
   1. **原因**：季度分割导致的编号问题
   2. **措施**：使用备选集数重新匹配


**特典：**

1. 如果前面均未匹配成功，则将剧集设置为特典`Special`
2. 使用 AnitomySharp 获取文件信息并修改原标题



## 季度识别

**涉及内容：**
- 季度识别
- 季度修正

**识别流程：**

1. 如果 Jellyfin 元数据中季度为`null`或`0`，则修改默认值为`1`，否则使用元数据值
   
         由于缺乏将季度设置为`1`的判断条件，而特典`Specials`判断条件多。将值设置为`1`有助于修正错误季度

2. 如果未勾选`使用 AnitomySharp 处理剧集`，且被默认基础规则判断为`Special`，则季度设为`0`
3. 如果剧集非`Normal`类型或者剧集 Bangumi ID 为 0（默认值），则季度设为`0`
4. 否则，若季度为`Season`，则继承其值

